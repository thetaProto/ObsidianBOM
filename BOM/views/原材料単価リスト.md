---
type: cost_view
modified on: 2026-02-01 07:25:42
---

```dataviewjs
const purchases = dv.pages('"BOM/purchases"')
  .where(p => p.type === "purchase" && p.material && p.qty && p.total_amount);

function linkText(x) {
  if (!x) return "";
  if (Array.isArray(x)) x = x[0];
  return (x.path) ? x.path : String(x);
}

function safeNum(x) {
  const n = Number(x);
  return Number.isFinite(n) ? n : 0;
}

const byMaterial = new Map();

for (const p of purchases) {
  const mat = linkText(p.material);
  if (!mat) continue;

  const qty = safeNum(p.qty);
  const total = safeNum(p.total_amount);
  if (qty <= 0 || total <= 0) continue;

  if (!byMaterial.has(mat)) {
    byMaterial.set(mat, { qtySum: 0, amountSum: 0, last: null });
  }
  const agg = byMaterial.get(mat);

  agg.qtySum += qty;
  agg.amountSum += total;

  const d = p.purchased_on ? new Date(p.purchased_on) : null;
  if (d && (!agg.last || d > agg.last)) agg.last = d;
}

const rows = [];
for (const [matPath, agg] of byMaterial.entries()) {
  const avg = agg.qtySum > 0 ? agg.amountSum / agg.qtySum : 0;
  const matPage = dv.page(matPath);
  const uom = (matPage?.uom != null && matPage?.uom !== "") ? String(matPage.uom) : "—";
  rows.push([
    dv.fileLink(matPath),
    agg.qtySum,
    Math.round(avg),
    uom,
    agg.last ? agg.last.toISOString().slice(0,10) : ""
  ]);
}

rows.sort((a,b)=> String(a[0]).localeCompare(String(b[0])));

dv.table(
  ["Material", "Total Qty", "Avg Unit Cost (JPY)", "単位", "Last Purchase"],
  rows
);
```
